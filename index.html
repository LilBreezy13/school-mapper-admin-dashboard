<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Field Marketer | School Locator</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyCAW4xYWromZksn2756co9nxAftX1zx8&libraries=places,geometry"></script>

<style>
  html,body{height:100%}
  #map{height:65vh}
</style>
</head>

<body class="bg-slate-100 overflow-hidden">

<!-- HEADER -->
<header class="bg-white shadow z-20">
  <div class="p-3 space-y-2">
    <h1 class="font-semibold">üìç School Locator</h1>

    <input id="searchInput"
      placeholder="Search nearby schools (press Enter)"
      class="w-full border rounded px-3 py-2 text-sm"/>

    <div class="grid grid-cols-2 gap-2">
      <select id="distanceFilter" class="border rounded px-2 py-2 text-sm">
        <option value="1">1 km</option>
        <option value="3">3 km</option>
        <option value="5" selected>5 km</option>
      </select>

      <select id="viewFilter" class="border rounded px-2 py-2 text-sm">
        <option value="all">All schools</option>
        <option value="onboarded">Onboarded only</option>
      </select>
    </div>
  </div>
</header>

<!-- MAP -->
<div id="map"></div>

<!-- INFO SHEET -->
<div id="infoSheet" class="fixed inset-x-0 bottom-0 bg-white rounded-t-2xl shadow hidden z-30">
  <div class="p-4 space-y-2">
    <div class="flex justify-between">
      <h2 id="infoName" class="font-semibold"></h2>
      <button onclick="closeInfo()">‚úï</button>
    </div>
    <p id="infoAddress" class="text-xs text-gray-500"></p>

    <div class="flex gap-2">
      <a id="callBtn"
        class="flex-1 bg-green-600 text-white py-2 rounded text-center text-sm">
        Call
      </a>
      <button id="dirBtn"
        class="flex-1 bg-blue-600 text-white py-2 rounded text-sm">
        Directions
      </button>
    </div>
  </div>
</div>

<!-- ADD BUTTON -->
<button onclick="openAddModal()"
  class="fixed bottom-6 right-4 bg-black text-white w-14 h-14 rounded-full text-3xl z-40">+</button>

<!-- ADD MODAL -->
<div id="addModal"
  onclick="closeAddModal(event)"
  class="fixed inset-0 bg-black/50 hidden z-50 flex items-end">

  <div class="bg-white w-full rounded-t-2xl p-4 space-y-3">
    <h3 class="font-semibold">Add New School</h3>

    <input id="newName"
      placeholder="School name"
      class="w-full border px-3 py-2 rounded"/>

    <input id="newContact"
      placeholder="Contact number"
      class="w-full border px-3 py-2 rounded"/>

    <p class="text-xs text-gray-500">
      GPS: <span id="gpsCoords"></span>
    </p>

    <button onclick="submitNewSchool()"
      class="w-full bg-blue-600 text-white py-2 rounded">
      Send Request
    </button>
  </div>
</div>

<script>
let map,userLoc,markers=[];
let directionsService,directionsRenderer;
let placesService,searchTimer=null;

const portalSchools=[
  {name:"Alpha Academy",lat:5.669,lng:-0.167,contact:"024000111"}
];

function init(){
  navigator.geolocation.getCurrentPosition(pos=>{
    userLoc={lat:pos.coords.latitude,lng:pos.coords.longitude};

    map=new google.maps.Map(document.getElementById("map"),{
      center:userLoc,
      zoom:15,
      gestureHandling:"greedy"
    });

    directionsService=new google.maps.DirectionsService();
    directionsRenderer=new google.maps.DirectionsRenderer();
    directionsRenderer.setMap(map);

    placesService=new google.maps.places.PlacesService(map);

    new google.maps.Marker({
      position:userLoc,
      map,
      icon:{path:google.maps.SymbolPath.CIRCLE,scale:7,fillColor:"#2563EB",fillOpacity:1}
    });

    loadSchools();
  },()=>alert("Please enable GPS"));
}

function clearMarkers(){
  markers.forEach(m=>m.setMap(null));
  markers=[];
}

function loadSchools(){
  clearMarkers();
  directionsRenderer.setDirections({routes:[]});

  const radius=distanceFilter.value*1000;
  const search=searchInput.value.toLowerCase();
  const view=viewFilter.value;

  portalSchools.forEach(s=>{
    if(view==="onboarded"||view==="all"){
      if(search&&!s.name.toLowerCase().includes(search))return;
      const m=new google.maps.Marker({
        position:{lat:s.lat,lng:s.lng},
        map,
        animation:google.maps.Animation.DROP,
        icon:{path:google.maps.SymbolPath.CIRCLE,scale:7,fillColor:"green",fillOpacity:1},
        title:s.name
      });
      m.addListener("click",()=>showPortal(s));
      markers.push(m);
    }
  });

  if(view==="onboarded")return;

  placesService.nearbySearch(
    {location:userLoc,radius,keyword:"school"},
    res=>{
      if(!res)return;
      res.forEach(p=>{
        if(search&&!p.name.toLowerCase().includes(search))return;
        const m=new google.maps.Marker({
          position:p.geometry.location,
          map,
          animation:google.maps.Animation.DROP,
          icon:{path:google.maps.SymbolPath.CIRCLE,scale:7,fillColor:"red",fillOpacity:1},
          title:p.name
        });
        m.addListener("click",()=>loadPlaceDetails(p.place_id));
        markers.push(m);
      });
    }
  );
}

function loadPlaceDetails(id){
  placesService.getDetails(
    {placeId:id,fields:["name","formatted_address","formatted_phone_number","geometry"]},
    p=>{
      infoName.textContent=p.name;
      infoAddress.textContent=p.formatted_address||"";
      callBtn.href=p.formatted_phone_number?"tel:"+p.formatted_phone_number:"#";
      dirBtn.onclick=()=>startDirections(
        p.geometry.location.lat(),
        p.geometry.location.lng()
      );
      infoSheet.classList.remove("hidden");
    }
  );
}

function showPortal(s){
  infoName.textContent=s.name;
  infoAddress.textContent="Onboarded school";
  callBtn.href="tel:"+s.contact;
  dirBtn.onclick=()=>startDirections(s.lat,s.lng);
  infoSheet.classList.remove("hidden");
}
function startDirections(lat, lng) {
  closeInfo();

  // üî• HARD RESET (this was missing)
  directionsRenderer.setMap(null);
  directionsRenderer = new google.maps.DirectionsRenderer({
    suppressMarkers: false,
    preserveViewport: false
  });
  directionsRenderer.setMap(map);

  directionsService.route(
    {
      origin: userLoc,
      destination: { lat, lng },
      travelMode: google.maps.TravelMode.WALKING
    },
    (result, status) => {
      if (status === "OK") {
        directionsRenderer.setDirections(result);

        // üîç Auto-fit route
        const bounds = new google.maps.LatLngBounds();
        result.routes[0].overview_path.forEach(p => bounds.extend(p));
        map.fitBounds(bounds);
      } else {
        alert("Directions failed: " + status);
      }
    }
  );
}


function closeInfo(){infoSheet.classList.add("hidden");}

function openAddModal(){
  gpsCoords.textContent=`${userLoc.lat.toFixed(5)}, ${userLoc.lng.toFixed(5)}`;
  addModal.classList.remove("hidden");
}

function closeAddModal(e){
  if(e.target.id==="addModal")addModal.classList.add("hidden");
}

function submitNewSchool(){
  if(!newName.value.trim()||!newContact.value.trim()){
    alert("Fill all fields");
    return;
  }
  console.log("REQUEST:",{
    name:newName.value,
    contact:newContact.value,
    lat:userLoc.lat,
    lng:userLoc.lng
  });
  addModal.classList.add("hidden");
  newName.value=newContact.value="";
  alert("Request sent ‚úî");
}

searchInput.addEventListener("keyup",e=>{
  if(e.key==="Enter")loadSchools();
});

distanceFilter.onchange=loadSchools;
viewFilter.onchange=loadSchools;

window.onload=init;
</script>

</body>
</html>
