<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Field Marketer | School Locator</title>

<script src="https://cdn.tailwindcss.com"></script>
<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyCAW4xYWromZksn2756co9nxAftX1zx8&libraries=places,geometry&callback=init"
  async
  defer>
</script>


<style>
*,*::before,*::after{box-sizing:border-box}
html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden}
#map{position:fixed;inset:0;width:100vw;height:100svh}

/* SEARCH */
.search-bar{
  position:fixed;
  top:env(safe-area-inset-top,24px);
  margin-top:5%;
  left:50%;
  transform:translateX(-50%);
  width:min(92vw,520px);
  z-index:50;
}

/* ICON RAIL */
.icon-rail{
  position:fixed;
  top:120px;
  left:12px;
  z-index:50;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.icon-btn{
  width:44px;height:44px;border-radius:50%;
  background:#111;color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-size:13px;
}
.icon-btn.active{background:#22c55e;color:#000}

/* BOTTOM SHEET */
.sheet{
  position:fixed;
  left:0;right:0;bottom:0;
  height:320px;
  background:#111;color:#fff;
  border-radius:24px 24px 0 0;
  transform:translateY(100%);
  transition:transform .25s ease-out;
  z-index:60;
  display:flex;
  flex-direction:column;
}
.sheet.show{transform:translateY(0)}

.sheet-handle{
  width:40px;height:4px;
  background:#444;
  border-radius:999px;
  margin:8px auto;
}

.sheet-header{
  position:relative;
}

.sheet-close{
  position:absolute;
  right:16px;
  top:6px;
  font-size:20px;
  color:#aaa;
}

.sheet-content{
  flex:1;
  overflow-y:auto;
  overflow-x:hidden;
  padding:0 16px 16px;
}

.photo-row{
  display:flex;
  gap:8px;
  overflow-x:auto;
}
.photo-row img{
  height:90px;
  min-width:120px;
  object-fit:cover;
  border-radius:12px;
  background:#222;
}

input{font-size:16px;min-width:0}
</style>
</head>

<body>

<div id="map"></div>

<!-- SEARCH -->
<div class="search-bar">
  <div class="flex items-center bg-[#2A2A2A] rounded-full px-3 py-2 shadow-lg">
    <span class="text-gray-400 mr-2">üìç</span>
    <input id="searchInput" type="search" placeholder="Search here"
      class="flex-1 bg-transparent text-white placeholder-gray-400 focus:outline-none"/>
    <button id="searchBtn" class="text-white ml-2">üîç</button>
  </div>
</div>

<!-- ICON RAIL -->
<div class="icon-rail">
  <button onclick="setRadius(1000)" class="icon-btn">1km</button>
  <button onclick="setRadius(3000)" class="icon-btn">3km</button>
  <button id="onboardBtn" onclick="toggleView()" class="icon-btn">üè´</button>
  <button onclick="openAddModal()" class="icon-btn">‚ûï</button>
</div>

<!-- BOTTOM SHEET -->
<div id="infoSheet" class="sheet">
  <div class="sheet-header">
    <div class="sheet-handle"></div>
    <button id="sheetCloseBtn" class="sheet-close">‚úï</button>
  </div>

  <div class="sheet-content space-y-3">
    <h2 id="infoName" class="text-lg font-semibold"></h2>
    <p id="infoAddress" class="text-sm text-gray-400"></p>
    <div id="infoRating" class="text-sm text-yellow-400"></div>
    <div id="photoRow" class="photo-row"></div>

    <div class="flex gap-3 pt-2">
      <button id="dirBtn"
        class="flex-1 bg-blue-500 text-black py-2 rounded-full">
        Directions
      </button>
      <a id="callBtn"
        class="flex-1 bg-green-500 text-black py-2 rounded-full text-center">
        Call
      </a>
    </div>
  </div>
</div>

<!-- ADD MODAL -->
<div id="addModal" onclick="closeAddModal(event)"
  class="fixed inset-0 bg-black/60 hidden z-[70] flex items-end">
  <div class="bg-white w-full rounded-t-2xl p-4 space-y-3">
    <h3 class="font-semibold">Add New School</h3>
    <input id="newName" placeholder="School name" class="w-full border px-3 py-2 rounded"/>
    <input id="newContact" placeholder="Contact number" class="w-full border px-3 py-2 rounded"/>
    <p class="text-xs text-gray-500">GPS: <span id="gpsCoords"></span></p>
    <button onclick="submitNewSchool()" class="w-full bg-blue-600 text-white py-2 rounded">
      Send Request
    </button>
  </div>
</div>

<!-- FIREBASE CORE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* =========================
   FIREBASE INIT
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDJxY9b7OecRhf5tmEf76Ak1bR1NW0UtJ0",
  authDomain: "school-mapper-65c74.firebaseapp.com",
  projectId: "school-mapper-65c74",
  storageBucket: "school-mapper-65c74.firebasestorage.app",
  messagingSenderId: "568455426705",
  appId: "1:568455426705:web:19aa46f56dddfda0bf0530",
  measurementId: "G-ZRXX104WC1"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* =========================
   GLOBAL STATE
========================= */
let map, userLoc, markers = [], radius = 5000, view = "all";
let placesService, activePlace = null;
let startY = 0, dragging = false;

/* onboarded schools from Firestore */
let portalSchools = [];

/* =========================
   INIT MAP
========================= */
function init(){
  navigator.geolocation.getCurrentPosition(p=>{
    userLoc = {
      lat: p.coords.latitude,
      lng: p.coords.longitude
    };

    map = new google.maps.Map(document.getElementById("map"),{
      center: userLoc,
      zoom: 15,
      disableDefaultUI: true,
      gestureHandling: "greedy"
    });

    placesService = new google.maps.places.PlacesService(map);

    new google.maps.Marker({
      position: userLoc,
      map,
      icon:{
        path: google.maps.SymbolPath.CIRCLE,
        scale: 7,
        fillColor: "#3B82F6",
        fillOpacity: 1
      }
    });

    loadPortalSchools();   // üî• FIREBASE
  });
}

/* =========================
   FIREBASE LOAD
========================= */
async function loadPortalSchools(){
  const snap = await db
    .collection("schools")
    .where("status", "==", "onboarded")
    .get();

  portalSchools = snap.docs.map(d => ({
    id: d.id,
    ...d.data()
  }));

  loadSchools();
}

/* =========================
   BOTTOM SHEET
========================= */
function openSheet(){
  infoSheet.classList.add("show");
  map.setOptions({ gestureHandling: "cooperative" });
}

function closeSheet(){
  infoSheet.classList.remove("show");
  map.setOptions({ gestureHandling: "greedy" });
}

sheetCloseBtn.onclick = closeSheet;

infoSheet.addEventListener("touchstart", e=>{
  startY = e.touches[0].clientY;
  dragging = true;
});
infoSheet.addEventListener("touchmove", e=>{
  if(!dragging) return;
  if(e.touches[0].clientY - startY > 80){
    closeSheet();
    dragging = false;
  }
});
infoSheet.addEventListener("touchend", ()=>dragging=false);

/* =========================
   FILTER CONTROLS
========================= */
function setRadius(r){
  radius = r;
  loadSchools();
}

function toggleView(){
  view = view === "all" ? "onboarded" : "all";
  onboardBtn.classList.toggle("active", view === "onboarded");
  loadSchools();
}

/* =========================
   MARKERS
========================= */
function clearMarkers(){
  markers.forEach(m=>m.setMap(null));
  markers = [];
}

function loadSchools(){
  clearMarkers();
  const q = searchInput.value.toLowerCase();

  /* GREEN ‚Äì FIREBASE */
  portalSchools.forEach(s=>{
    if(view==="onboarded" || view==="all"){
      if(q && !s.name.toLowerCase().includes(q)) return;

      const m = new google.maps.Marker({
        position:{ lat:s.lat, lng:s.lng },
        map,
        icon:{
          path: google.maps.SymbolPath.CIRCLE,
          scale: 7,
          fillColor: "green",
          fillOpacity: 1
        }
      });

      m.addListener("click", ()=>showPortal(s));
      markers.push(m);
    }
  });

  if(view==="onboarded") return;

  /* RED ‚Äì GOOGLE */
  placesService.nearbySearch(
    { location:userLoc, radius, keyword:"school" },
    res=>{
      (res||[]).forEach(p=>{
        if(q && !p.name.toLowerCase().includes(q)) return;

        const m = new google.maps.Marker({
          position:p.geometry.location,
          map,
          icon:{
            path: google.maps.SymbolPath.CIRCLE,
            scale: 7,
            fillColor: "red",
            fillOpacity: 1
          }
        });

        m.addListener("click", ()=>loadPlaceDetails(p.place_id));
        markers.push(m);
      });
    }
  );
}

/* =========================
   PLACE DETAILS
========================= */
function loadPlaceDetails(placeId){
  placesService.getDetails({
    placeId,
    fields:[
      "name",
      "formatted_address",
      "formatted_phone_number",
      "rating",
      "user_ratings_total",
      "photos",
      "geometry"
    ]
  }, p=>{
    activePlace = p;

    infoName.textContent = p.name;
    infoAddress.textContent = p.formatted_address || "";
    infoRating.innerHTML = p.rating
      ? `‚≠ê ${p.rating} (${p.user_ratings_total})`
      : "";

    photoRow.innerHTML = "";
    (p.photos||[]).slice(0,6).forEach(ph=>{
      const img = document.createElement("img");
      img.src = ph.getUrl({ maxHeight:200 });
      photoRow.appendChild(img);
    });

    callBtn.href = p.formatted_phone_number
      ? "tel:"+p.formatted_phone_number
      : "#";

    dirBtn.onclick = ()=>openNavigation(
      p.geometry.location.lat(),
      p.geometry.location.lng()
    );

    openSheet();
  });
}

/* =========================
   PORTAL SCHOOL
========================= */
function showPortal(s){
  infoName.textContent = s.name;
  infoAddress.textContent = s.address || "Onboarded school";
  infoRating.innerHTML = "";
  photoRow.innerHTML = "";
  callBtn.href = s.contact ? "tel:"+s.contact : "#";
  dirBtn.onclick = ()=>openNavigation(s.lat, s.lng);
  openSheet();
}

/* =========================
   NAVIGATION
========================= */
function openNavigation(lat,lng){
  localStorage.setItem("lastPlace","1");
  window.location.href =
    `https://www.google.com/maps/dir/?api=1&origin=${userLoc.lat},${userLoc.lng}&destination=${lat},${lng}&travelmode=walking`;
}

/* =========================
   ADD SCHOOL REQUEST
========================= */
async function submitNewSchool(){
  if(!newName.value || !newContact.value){
    alert("Fill all fields");
    return;
  }

  await db.collection("requests").add({
    name: newName.value,
    contact: newContact.value,
    lat: userLoc.lat,
    lng: userLoc.lng,
    status: "pending",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  newName.value = "";
  newContact.value = "";
  addModal.classList.add("hidden");
  alert("Request sent to dashboard");
}

/* =========================
   SEARCH
========================= */
searchBtn.onclick = loadSchools;
searchInput.onkeyup = e=>e.key==="Enter" && loadSchools();

/* =========================
   BOOT
========================= */
// window.onload = init;
</script>

</body>
</html>
