<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Field Marketer | School Locator</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Maps (REPLACE KEY LATER) -->
 <script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAyCAW4xYWromZksn2756co9nxAftX1zx8&libraries=places,geometry">
</script>

</head>

<body class="bg-slate-100 text-slate-800">

<!-- HEADER -->
<header class="sticky top-0 bg-white shadow z-20">
  <div class="p-4 flex items-center justify-between">
    <h1 class="font-semibold text-lg">üìç School Locator</h1>
    <span class="text-xs text-slate-500">Field Marketer</span>
  </div>

  <!-- FILTERS -->
  <div class="p-3 grid grid-cols-2 gap-2 text-sm">
    <input id="searchInput" placeholder="Search school or location"
      class="border rounded-lg px-3 py-2 col-span-2">

    <select id="regionFilter" class="border rounded-lg px-3 py-2">
      <option value="">All Regions</option>
      <option>Greater Accra</option>
      <option>Ashanti</option>
      <option>Central</option>
      <option>Western</option>
      <option>Eastern</option>
      <option>Volta</option>
      <option>Oti</option>
      <option>Northern</option>
    </select>

    <select id="examFilter" class="border rounded-lg px-3 py-2">
      <option value="">All Exams</option>
      <option value="mock">Has Mock</option>
      <option value="terminal">Has Terminal</option>
    </select>
  </div>
</header>

<!-- MAP -->
<div id="map" class="h-[70vh] w-full"></div>


<!-- SCHOOL LIST -->
<section id="schoolList" class="p-4 space-y-3"></section>

<!-- MODAL -->
<div id="schoolModal" class="fixed inset-0 bg-black/40 hidden z-30">
  <div class="absolute bottom-0 w-full bg-white rounded-t-2xl p-5 max-h-[85vh] overflow-y-auto">

  <div class="space-y-4">

  <div class="flex justify-between items-center">
    <div>
      <h2 id="mName" class="text-xl font-bold"></h2>
      <p class="text-xs text-slate-500">
        <span id="mLocation"></span> ‚Ä¢ <span id="mRegion"></span>
      </p>
    </div>
    <button onclick="closeModal()" class="text-slate-400 hover:text-red-500">
      ‚úï
    </button>
  </div>

  <div class="grid grid-cols-2 gap-3 text-sm">
    <div class="bg-slate-100 p-3 rounded-lg">
      <p class="text-xs text-slate-500">Longevity</p>
      <p class="font-semibold" id="mLongevity"></p>
    </div>

    <div class="bg-slate-100 p-3 rounded-lg">
      <p class="text-xs text-slate-500">Contact</p>
      <p class="font-semibold" id="mContact"></p>
    </div>
  </div>

  <div>
    <h3 class="font-semibold mb-2">üìò Mock Exams</h3>
    <ul id="mMocks" class="text-sm space-y-1"></ul>
  </div>

  <div>
    <h3 class="font-semibold mb-2">üìó Terminal Exams</h3>
    <ul id="mTerminals" class="text-sm space-y-1"></ul>
  </div>

</div>


  </div>
</div>

<script>
/* =====================================================
   SAMPLE DATA (MATCHES DASHBOARD)
   REPLACE WITH FIREBASE onSnapshot() LATER
===================================================== */

let schools = [
  {
    id: "sch_001",
    name: "Alpha Academy",
    region: "Greater Accra",
    location: "Madina",
    lat: 5.669,
    lng: -0.167,
    contact: "024000111",
    addedAt: "2021-01-01",
    mocks: [{ name: "Mock 1", enrollment: 120 }],
    terminals: [{ name: "Terminal 1", enrollment: 130 }],
    onboarded: true
  }
];

/* =====================================================
   DOM ELEMENTS
===================================================== */

const schoolList   = document.getElementById("schoolList");
const searchInput  = document.getElementById("searchInput");
const regionFilter = document.getElementById("regionFilter");
const examFilter   = document.getElementById("examFilter");

const schoolModal = document.getElementById("schoolModal");
const mName = document.getElementById("mName");
const mRegion = document.getElementById("mRegion");
const mLocation = document.getElementById("mLocation");
const mLongevity = document.getElementById("mLongevity");
const mContact = document.getElementById("mContact");
const mMocks = document.getElementById("mMocks");
const mTerminals = document.getElementById("mTerminals");

/* =====================================================
   HELPERS
===================================================== */

function yearsOld(date) {
  if (!date) return "‚Äî";
  return Math.floor(
    (Date.now() - new Date(date)) / (1000 * 60 * 60 * 24 * 365)
  ) + " yrs";
}

/* =====================================================
   GOOGLE MAP + LOCATION
===================================================== */

let map;
let markers = [];
let userLocation = null;
const MATCH_RADIUS = 120; // meters

function getUserLocation() {
  if (!navigator.geolocation) {
    alert("Geolocation not supported");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      userLocation = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude
      };
      initMap();
      findNearbySchools();
    },
    () => alert("Location access denied. Enable GPS."),
    { enableHighAccuracy: true }
  );
}

function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: userLocation || { lat: 5.6037, lng: -0.187 },
    zoom: userLocation ? 15 : 7
  });

  if (userLocation) {
    new google.maps.Marker({
      position: userLocation,
      map,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: "#2563EB",
        fillOpacity: 1,
        strokeWeight: 2,
        strokeColor: "#fff"
      },
      title: "Your Location"
    });
  }
}


function renderFilteredMapMarkers(filteredSchools) {
  clearMarkers();

  filteredSchools.forEach(s => {
    if (!s.lat || !s.lng) return;

    const marker = new google.maps.Marker({
      position: { lat: s.lat, lng: s.lng },
      map,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 7,
        fillColor: s.onboarded ? "green" : "red",
        fillOpacity: 1,
        strokeWeight: 1
      }
    });

    marker.addListener("click", () => openModal(s));
    markers.push(marker);
  });
}


/* =====================================================
   NEARBY SCHOOLS (GOOGLE PLACES)
===================================================== */

function findNearbySchools() {
  const service = new google.maps.places.PlacesService(map);

  service.nearbySearch(
    {
      location: userLocation,
      radius: 3000,
      keyword: "school"
    },
    (results, status) => {
      if (status !== "OK") return;
      renderNearbyMarkers(results);
    }
  );
}



function isOnboarded(place) {
  return schools.find(s => {
    if (!s.lat || !s.lng) return false;

    const dist = google.maps.geometry.spherical.computeDistanceBetween(
      new google.maps.LatLng(place.geometry.location.lat(), place.geometry.location.lng()),
      new google.maps.LatLng(s.lat, s.lng)
    );

    return dist <= MATCH_RADIUS;
  });
}

function renderNearbyMarkers(places) {
  clearMarkers();

  places.forEach(place => {
    const onboardedSchool = isOnboarded(place);

    const marker = new google.maps.Marker({
      position: place.geometry.location,
      map,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 7,
        fillColor: onboardedSchool ? "green" : "red",
        fillOpacity: 1,
        strokeWeight: 1
      }
    });

    marker.addListener("click", () => {
      onboardedSchool
        ? openModal(onboardedSchool)
        : openNewSchoolModal(place);
    });

    markers.push(marker);
  });
}

function clearMarkers() {
  markers.forEach(m => m.setMap(null));
  markers = [];
}

/* =====================================================
   RENDER LIST (DASHBOARD DATA)
===================================================== */
function renderSchools() {
  schoolList.innerHTML = "";

  const search = searchInput.value.toLowerCase();
  const region = regionFilter.value;
  const exam   = examFilter.value;

  const filtered = schools.filter(s => {
    if (search && !(`${s.name} ${s.location || ""}`.toLowerCase().includes(search))) return false;
    if (region && s.region !== region) return false;
    if (exam === "mock" && (!s.mocks || !s.mocks.length)) return false;
    if (exam === "terminal" && (!s.terminals || !s.terminals.length)) return false;
    return true;
  });

  // render list
  filtered.forEach(s => {
    const card = document.createElement("div");
    card.className = "bg-white rounded-xl p-4 shadow flex justify-between items-center";

    card.innerHTML = `
      <div>
        <h3 class="font-semibold text-sm">${s.name}</h3>
        <p class="text-xs text-gray-500">${s.location || "Unknown"} ‚Ä¢ ${s.region}</p>
        <p class="text-xs mt-1">‚è± ${yearsOld(s.addedAt)}</p>
      </div>
      <span class="w-3 h-3 rounded-full ${s.onboarded ? "bg-green-500" : "bg-red-500"}"></span>
    `;

    card.onclick = () => {
      map.panTo({ lat: s.lat, lng: s.lng });
      map.setZoom(16);
      openModal(s);
    };

    schoolList.appendChild(card);
  });

  // üî• IMPORTANT: also update map markers
  renderFilteredMapMarkers(filtered);
}

/* =====================================================
   MODALS
===================================================== */

function openModal(s) {
  schoolModal.classList.remove("hidden");

  mName.textContent = s.name;
  mRegion.textContent = s.region || "‚Äî";
  mLocation.textContent = s.location || "‚Äî";
  mLongevity.textContent = yearsOld(s.addedAt);
  mContact.textContent = s.contact || "‚Äî";

  mMocks.innerHTML = s.mocks?.length
    ? s.mocks.map(m => `<li>‚Ä¢ ${m.name} ‚Äî ${m.enrollment}</li>`).join("")
    : "<li>‚Äî</li>";

  mTerminals.innerHTML = s.terminals?.length
    ? s.terminals.map(t => `<li>‚Ä¢ ${t.name} ‚Äî ${t.enrollment}</li>`).join("")
    : "<li>‚Äî</li>";
}

function closeModal() {
  schoolModal.classList.add("hidden");
}

/* =====================================================
   NEW SCHOOL REPORT (ADMIN REVIEW)
===================================================== */

let pendingSchool = null;

function openNewSchoolModal(place) {
  pendingSchool = place;
  alert(`New School Detected:\n${place.name}\nSend to admin.`);
  // Firebase write later
}

/* =====================================================
   EVENTS + INIT
===================================================== */

searchInput.oninput = renderSchools;
regionFilter.onchange = renderSchools;
examFilter.onchange = renderSchools;

window.onload = () => {
  renderSchools();
  getUserLocation();
};
</script>

</body>
</html>
